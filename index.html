<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot học tập THPT</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f5f7fa;
            color: #333;
            overflow: hidden;
        }

        /* Main container */
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #ffffff;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            margin: 20px;
            overflow: hidden;
        }

        /* Header */
        .app-header {
            background: linear-gradient(135deg, #3a7bd5, #00d2ff);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .app-header h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .app-header .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Subject Selection Screen */
        #subjectScreen {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            padding: 20px;
            text-align: center;
        }

        #subjectScreen h2 {
            color: #3a7bd5;
            margin-bottom: 30px;
            font-size: 2rem;
        }

        .subject-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            width: 80%;
            max-width: 800px;
            margin: 0 auto;
        }

        .subject-button {
            background: linear-gradient(135deg, #3a7bd5, #00d2ff);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 25px 20px;
            font-size: 1.3rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(58, 123, 213, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 180px;
        }

        .subject-button i {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .subject-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(58, 123, 213, 0.4);
        }

        /* Chatbot Screen */
        #chatbot-container {
            display: none;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }

        .chat-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        #khung-tro-chuyen {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column;
        }

        .tin-nhan {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 12px;
            max-width: 80%;
            position: relative;
            word-wrap: break-word;
            line-height: 1.5;
            font-size: 1rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tin-nhan-nguoi-dung {
            background-color: #3a7bd5;
            color: white;
            margin-left: auto;
            text-align: right;
            border-bottom-right-radius: 5px;
        }

        .tin-nhan-bot {
            background-color: #ffffff;
            color: #333;
            margin-right: auto;
            text-align: left;
            border-bottom-left-radius: 5px;
            border: 1px solid #e0e0e0;
        }

        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 5px;
            text-align: right;
        }

        #khu-vuc-nhap {
            display: flex;
            padding: 15px;
            background-color: #ffffff;
            border-top: 1px solid #e0e0e0;
            align-items: center;
        }

        #o-nhap-tin-nhan-container {
            position: relative;
            flex-grow: 1;
            min-height: 50px;
        }

        #o-nhap-tin-nhan {
            width: 100%;
            background: #f5f7fa;
            color: transparent;
            caret-color: #333;
            padding: 12px 50px 12px 20px;
            border: 1px solid #e0e0e0;
            border-radius: 25px;
            outline: none;
            font-size: 1rem;
            transition: all 0.3s ease;
            min-height: 50px;
            resize: none;
            overflow: hidden;
        }

        #o-nhap-tin-nhan:focus {
            border-color: #3a7bd5;
            box-shadow: 0 0 0 3px rgba(58, 123, 213, 0.2);
        }

        #o-nhap-tin-nhan-preview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            min-height: 50px;
            padding: 12px 50px 12px 20px;
            pointer-events: none;
            z-index: 1;
            white-space: pre-wrap;
            overflow: hidden;
            color: #333;
            border: 1px solid transparent;
            border-radius: 25px;
            font-size: 1rem;
            line-height: 1.5;
        }

        #nut-gui {
            background-color: #3a7bd5;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-left: 10px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            transition: all 0.3s ease;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2;
        }

        #nut-gui:hover {
            background-color: #2c65c4;
        }

        #nut-gui:active {
            transform: translateY(-50%) scale(0.95);
        }

        /* Back button */
        .back-button {
            background-color: transparent;
            border: none;
            color: #3a7bd5;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
            margin-right: auto;
        }

        .back-button:hover {
            background-color: #f0f4ff;
        }

        /* Loading indicator */
        .loading-indicator {
            display: none;
            padding: 10px 15px;
            background-color: #ffffff;
            border-radius: 12px;
            margin-bottom: 15px;
            margin-right: auto;
            border: 1px solid #e0e0e0;
            width: fit-content;
        }

        .loading-dots {
            display: flex;
            gap: 5px;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #3a7bd5;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .main-container {
                margin: 0;
                border-radius: 0;
            }

            .app-header h1 {
                font-size: 1.5rem;
            }

            .subject-buttons {
                grid-template-columns: 1fr;
                width: 100%;
            }

            .subject-button {
                padding: 20px;
                height: 150px;
                font-size: 1.1rem;
            }

            .subject-button i {
                font-size: 2.5rem;
            }

            #khung-tro-chuyen {
                padding: 15px;
            }

            .tin-nhan {
                max-width: 90%;
                padding: 10px 15px;
                font-size: 0.95rem;
            }

            #khu-vuc-nhap {
                padding: 10px;
            }

            #o-nhap-tin-nhan, #o-nhap-tin-nhan-preview {
                padding: 10px 45px 10px 15px;
                min-height: 45px;
                font-size: 0.95rem;
            }

            #nut-gui {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }
        }

        /* Math formatting */
        .fraction {
            display: inline-block;
            text-align: center;
            vertical-align: middle;
            margin: 0 2px;
        }
        
        .fraction span {
            display: block;
        }
        
        .fraction .numerator {
            border-bottom: 1px solid #000;
            padding: 0 3px;
        }
        
        .fraction .denominator {
            padding: 0 3px;
        }

        .mixed-number {
            display: inline-flex;
            align-items: center;
            vertical-align: middle;
            margin: 0 2px;
        }
        
        .mixed-number .whole-part {
            padding-right: 2px;
        }
        
        .mixed-number .fraction {
            display: inline-block;
        }

        /* Equation styling */
        .equation {
            font-family: "Cambria Math", serif;
            background-color: #f5f5f5;
            padding: 2px 5px;
            border-radius: 4px;
            display: inline-block;
            margin: 2px 0;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="app-header">
            <div class="logo">
                <i class="fas fa-graduation-cap"></i>
                <h1>Chatbot Học Tập THPT</h1>
            </div>
        </div>

        <!-- Subject Selection Screen -->
        <div id="subjectScreen">
            <h2>Chọn môn học</h2>
            <div class="subject-buttons">
                <button class="subject-button" data-subject="vat-ly">
                    <i class="fas fa-atom"></i>
                    Vật Lý
                </button>
                <button class="subject-button" data-subject="hoa-hoc">
                    <i class="fas fa-flask"></i>
                    Hóa Học
                </button>
            </div>
        </div>

        <!-- Chatbot Screen -->
        <div id="chatbot-container">
            <button class="back-button" id="backButton">
                <i class="fas fa-arrow-left"></i> Quay lại môn học
            </button>
            <div class="chat-area">
                <div id="khung-tro-chuyen"></div>
                <div class="loading-indicator" id="loadingIndicator">
                    <div class="loading-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
                <div id="khu-vuc-nhap">
                    <div id="o-nhap-tin-nhan-container">
                        <textarea id="o-nhap-tin-nhan" placeholder="Nhập câu hỏi của bạn..." rows="1"></textarea>
                        <div id="o-nhap-tin-nhan-preview"></div>
                        <button id="nut-gui">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="importmap">
        {
            "imports": {
                "@google/generative-ai": "https://esm.run/@google/generative-ai"
            }
        }
    </script>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCyhGASygL5BVBB-0pJJNwoyTZ61pAzP7c",
            authDomain: "tieuhoc-a7f57.firebaseapp.com",
            projectId: "tieuhoc-a7f57",
            storageBucket: "tieuhoc-a7f57.appspot.com",
            messagingSenderId: "736631398515",
            appId: "1:736631398515:web:a41bbabeeb98c3df42ca06"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Gemini AI configuration
        const KHOA_API = "AIzaSyAn9dMMM5u8dEGpI8mEzQvdMSuI8KFH8jM"; 
        const moHinhAI = new GoogleGenerativeAI(KHOA_API);
        const moHinh = moHinhAI.getGenerativeModel({ model: "gemini-2.0-flash-thinking-exp-01-21" });

        // DOM elements
        const subjectScreen = document.getElementById('subjectScreen');
        const chatbotContainer = document.getElementById('chatbot-container');
        const khungTroChuyen = document.getElementById('khung-tro-chuyen');
        const oNhapTinNhan = document.getElementById('o-nhap-tin-nhan');
        const oNhapTinNhanPreview = document.getElementById('o-nhap-tin-nhan-preview');
        const nutGui = document.getElementById('nut-gui');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const subjectButtons = document.querySelectorAll('.subject-button');
        const backButton = document.getElementById('backButton');

        // Global variables
        let currentSubject = '';
        let chatHistory = [];
        let currentExercises = [];

        // Subject filters for AI responses
        const subjectFilters = {
            "vat-ly": {
                name: "Vật Lý",
                excludeKeywords: ["lượng tử", "hạt nhân", "thuyết tương đối", "vật lý hạt cơ bản"],
                homeworkExamples: []
            },
            "hoa-hoc": {
                name: "Hóa Học",
                excludeKeywords: ["hóa học lượng tử", "hóa học phức tạp", "phản ứng hạt nhân", "hóa sinh nâng cao"],
                homeworkExamples: []
            }
        };

        const generalExcludeKeywords = [
            "đại học", "cao học", "nghiên cứu", "phân tích chuyên sâu", "triết học",
            "kinh tế vĩ mô", "chính trị quốc tế", "tôn giáo", "đức tin"
        ];
        
        // Homework request phrases
        const homeworkRequestPhrases = /(cho (tôi|em) bài tập|xin bài tập|gợi ý bài tập|bài tập về)/;

        // Back to subject selection function
        function backToSubjects() {
            currentSubject = '';
            subjectScreen.style.display = 'flex';
            chatbotContainer.style.display = 'none';
        }

        // Initialize the app
        function initApp() {
            // Add event listeners to subject buttons
            subjectButtons.forEach(button => {
                button.addEventListener('click', () => selectSubject(button.dataset.subject));
            });

            // Add event listener to send button
            nutGui.addEventListener('click', guiTinNhan);
            
            // Add event listener for back button
            backButton.addEventListener('click', backToSubjects);
            
            // Add event listener for Enter key in message input
            oNhapTinNhan.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    guiTinNhan();
                }
            });

            // Update input preview when typing
            oNhapTinNhan.addEventListener('input', function() {
                updateInputPreview();
                adjustTextareaHeight();
            });

            // Load chat history from localStorage if available
            loadChatHistory();
        }

        // Adjust textarea height based on content
        function adjustTextareaHeight() {
            oNhapTinNhan.style.height = 'auto';
            oNhapTinNhan.style.height = (oNhapTinNhan.scrollHeight) + 'px';
            oNhapTinNhanPreview.style.height = oNhapTinNhan.style.height;
        }

        // Update input preview
        function updateInputPreview() {
            const text = oNhapTinNhan.value;
            oNhapTinNhanPreview.innerHTML = formatMathExpressions(escapeHtml(text));
        }

        // Escape HTML to prevent XSS
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Format math expressions in text
        function formatMathExpressions(text) {
            // Process mixed numbers first: format number(fraction) or number (fraction)
            const mixedNumberRegex = /(\d+)(?:\s|)(\()(\d+)\/(\d+)(\))/g;
            let processedText = text.replace(mixedNumberRegex, (match, whole, p1, numerator, denominator, p2) => {
                return `<span class="mixed-number"><span class="whole-part">${whole}</span><span class="fraction"><span class="numerator">${numerator}</span><span class="denominator">${denominator}</span></span></span>`;
            });
            
            // Process simple fractions: number/number
            const fractionRegex = /([^\/\s]+)\/([^\/\s]+)/g;
            processedText = processedText.replace(fractionRegex, (match, numerator, denominator) => {
                // Check if it's already processed as mixed number
                if (processedText.includes(`<span class="mixed-number"><span class="whole-part">`)) {
                    return match;
                }
                return `<span class="fraction"><span class="numerator">${numerator}</span><span class="denominator">${denominator}</span></span>`;
            });
            
            // Process equations (simple format)
            const equationRegex = /\[equation\](.*?)\[\/equation\]/g;
            processedText = processedText.replace(equationRegex, (match, equation) => {
                return `<span class="equation">${equation}</span>`;
            });
            
            return processedText;
        }

        // Select subject
        function selectSubject(subject) {
            currentSubject = subject;
            subjectScreen.style.display = 'none';
            chatbotContainer.style.display = 'flex';
            
            // Load exercises for the selected subject
            loadExercises();
            
            // Show welcome message if this is the first time selecting this subject
            if (!chatHistory.some(msg => msg.subject === subject)) {
                themTinNhanVaoGiaoDien("bot", `Chào bạn! Tôi là trợ lý học tập môn ${subjectFilters[subject].name}. Bạn có câu hỏi gì về môn học này không?`);
                addToChatHistory("bot", `Chào bạn! Tôi là trợ lý học tập môn ${subjectFilters[subject].name}. Bạn có câu hỏi gì về môn học này không?`, subject);
            } else {
                // Load previous chat history for this subject
                loadSubjectChatHistory(subject);
            }
        }

        // Load exercises for the selected subject
        async function loadExercises() {
            currentExercises = [];
            
            try {
                // In a real app, you would load exercises from Firestore or an API
                // For demo purposes, we'll use a mock data approach
                
                // Try to load exercises from localStorage first
                const savedExercises = localStorage.getItem(`exercises_${currentSubject}`);
                if (savedExercises) {
                    currentExercises = JSON.parse(savedExercises);
                } else {
                    // If not in localStorage, load from a text file (simulated)
                    const response = await fetch(`baitap_${currentSubject}.txt`);
                    if (response.ok) {
                        const text = await response.text();
                        const exercises = text.split('\n').filter(line => line.trim() !== '');
                        currentExercises = exercises.map((ex, index) => ({
                            id: index + 1,
                            question: ex.trim()
                        }));
                        
                        // Save to localStorage for future use
                        localStorage.setItem(`exercises_${currentSubject}`, JSON.stringify(currentExercises));
                    }
                }
                
                // Update subject filters with loaded exercises
                if (subjectFilters[currentSubject]) {
                    subjectFilters[currentSubject].homeworkExamples = currentExercises.map(ex => ex.question);
                }
            } catch (error) {
                console.error('Lỗi khi tải bài tập:', error);
            }
        }

        // Add message to chat interface
        function themTinNhanVaoGiaoDien(nguoiGui, vanBan) {
            const divTinNhan = document.createElement('div');
            divTinNhan.classList.add('tin-nhan', `tin-nhan-${nguoiGui}`);

            // Format math expressions before processing markdown
            let processedText = formatMathExpressions(vanBan);
            
            // Convert basic markdown (bold, italic, line breaks)
            processedText = processedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            processedText = processedText.replace(/\*(.*?)\*/g, '<em>$1</em>');
            processedText = processedText.replace(/\n/g, '<br>');

            // Add current time
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            divTinNhan.innerHTML = processedText + `<div class="message-time">${timeString}</div>`;
            khungTroChuyen.appendChild(divTinNhan);
            
            // Scroll to bottom of chat
            khungTroChuyen.scrollTop = khungTroChuyen.scrollHeight;
        }

        // Add message to chat history
        function addToChatHistory(nguoiGui, vanBan, subject) {
            chatHistory.push({
                sender: nguoiGui,
                message: vanBan,
                subject: subject,
                timestamp: new Date().toISOString()
            });
            
            // Save to localStorage
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        }

        // Load chat history from localStorage
        function loadChatHistory() {
            const savedHistory = localStorage.getItem('chatHistory');
            if (savedHistory) {
                chatHistory = JSON.parse(savedHistory);
            }
        }

        // Load chat history for a specific subject
        function loadSubjectChatHistory(subject) {
            // Clear current chat
            khungTroChuyen.innerHTML = '';
            
            // Filter messages for this subject
            const subjectMessages = chatHistory.filter(msg => msg.subject === subject);
            
            // Display all messages
            subjectMessages.forEach(msg => {
                themTinNhanVaoGiaoDien(msg.sender, msg.message);
            });
            
            // If no messages, show welcome
            if (subjectMessages.length === 0) {
                themTinNhanVaoGiaoDien("bot", `Chào bạn! Tôi là trợ lý học tập môn ${subjectFilters[subject].name}. Bạn có câu hỏi gì về môn học này không?`);
                addToChatHistory("bot", `Chào bạn! Tôi là trợ lý học tập môn ${subjectFilters[subject].name}. Bạn có câu hỏi gì về môn học này không?`, subject);
            }
        }

        // Send message
        async function guiTinNhan() {
            const tinNhanNguoiDung = oNhapTinNhan.value.trim();
            if (!tinNhanNguoiDung) return;

            themTinNhanVaoGiaoDien("nguoi-dung", tinNhanNguoiDung);
            addToChatHistory("nguoi-dung", tinNhanNguoiDung, currentSubject);
            
            oNhapTinNhan.value = '';
            oNhapTinNhanPreview.innerHTML = '';
            adjustTextareaHeight();

            // Show loading indicator
            loadingIndicator.style.display = 'block';
            khungTroChuyen.scrollTop = khungTroChuyen.scrollHeight;

            try {
                // Handle simple greetings
                const loiChao = ["chào"];
                if (loiChao.some(chao => tinNhanNguoiDung.toLowerCase().includes(chao))) {
                    setTimeout(() => {
                        loadingIndicator.style.display = 'none';
                        const response = `Chào bạn! Tôi là trợ lý học tập môn ${subjectFilters[currentSubject].name}. Bạn có câu hỏi gì về môn học này không?`;
                        themTinNhanVaoGiaoDien("bot", response);
                        addToChatHistory("bot", response, currentSubject);
                    }, 1000);
                    return;
                }

                // --- HOMEWORK REQUEST LOGIC ---
                const isAskingForHomework = homeworkRequestPhrases.test(tinNhanNguoiDung.toLowerCase());

                if (isAskingForHomework) {
                    setTimeout(() => {
                        loadingIndicator.style.display = 'none';
                        
                        if (currentExercises && currentExercises.length > 0) {
                            let examples = currentExercises.map((e, i) => `${i + 1}. ${e.question}`).join('\n');
                            const response = `Dưới đây là một số bài tập môn ${subjectFilters[currentSubject].name}:\n${examples}\n\nBạn hãy thử giải các bài tập này và hỏi tôi nếu có bất kỳ câu hỏi nào về cách làm nhé!`;
                            themTinNhanVaoGiaoDien("bot", response);
                            addToChatHistory("bot", response, currentSubject);
                        } else {
                            const response = `Hiện không có bài tập nào trong môn ${subjectFilters[currentSubject].name}. Bạn có thể hỏi tôi về cách làm một dạng bài tập nào đó, tôi sẽ hướng dẫn bạn!`;
                            themTinNhanVaoGiaoDien("bot", response);
                            addToChatHistory("bot", response, currentSubject);
                        }
                    }, 1500);
                    return;
                }
                // --- END HOMEWORK REQUEST LOGIC ---

                // Check if question is appropriate for high school level
                if (!laCauHoiTHPT(tinNhanNguoiDung)) {
                    setTimeout(() => {
                        loadingIndicator.style.display = 'none';
                        const response = "Xin lỗi, tôi chỉ có thể giúp bạn với các câu hỏi và bài tập ở cấp độ THPT. Vui lòng hỏi những câu hỏi phù hợp hơn nhé.";
                        themTinNhanVaoGiaoDien("bot", response);
                        addToChatHistory("bot", response, currentSubject);
                    }, 1000);
                    return;
                }

                // Send question to AI model if it's not a homework request and is appropriate
                const subjectName = subjectFilters[currentSubject]?.name || currentSubject;
                
                // Include relevant chat history for context
                const relevantHistory = chatHistory
                    .filter(msg => msg.subject === currentSubject)
                    .slice(-5) // Last 5 messages
                    .map(msg => `${msg.sender === 'nguoi-dung' ? 'Bạn' : 'Bot'}: ${msg.message}`)
                    .join('\n');
                
                const prompt = `Bạn là một trợ lý học tập thông minh chuyên về môn ${subjectName} cấp THPT. 
                Hãy trả lời câu hỏi của học sinh một cách rõ ràng, chính xác và dễ hiểu. 
                Nếu câu hỏi không phù hợp với chương trình THPT, hãy từ chối trả lời một cách lịch sự.
                Chỉ giải bài tập khi được yêu cầu cụ thể, nếu không hãy hướng dẫn phương pháp giải.
                
                Lịch sử trò chuyện gần đây:
                ${relevantHistory}
                
                Câu hỏi hiện tại: ${tinNhanNguoiDung}`;

                const ketQua = await moHinh.generateContent(prompt);
                const phanHoi = await ketQua.response;
                const traLoiBot = phanHoi.text();
                
                loadingIndicator.style.display = 'none';
                themTinNhanVaoGiaoDien("bot", traLoiBot);
                addToChatHistory("bot", traLoiBot, currentSubject);

            } catch (loi) {
                console.error("Lỗi khi gọi API Gemini: ", loi);
                loadingIndicator.style.display = 'none';
                const response = "Rất tiếc, tôi không thể kết nối đến hệ thống AI ngay lúc này. Vui lòng kiểm tra kết nối mạng của bạn hoặc thử lại sau!";
                themTinNhanVaoGiaoDien("bot", response);
                addToChatHistory("bot", response, currentSubject);
            }
        }

        /**
         * Check if a question is appropriate for high school level.
         * @param {string} cauHoi - User's question.
         * @returns {boolean} - True if appropriate, False if not.
         */
        function laCauHoiTHPT(cauHoi) {
            const cauHoiThuong = cauHoi.toLowerCase();

            // Check general exclude keywords
            const laKhongTHPTChung = generalExcludeKeywords.some(tuKhoa => cauHoiThuong.includes(tuKhoa));
            if (laKhongTHPTChung) return false;

            // Check subject-specific exclude keywords
            if (subjectFilters[currentSubject]) {
                const subjectSpecificKeywords = subjectFilters[currentSubject].excludeKeywords;
                const laKhongTHPTMonHoc = subjectSpecificKeywords.some(tuKhoa => cauHoiThuong.includes(tuKhoa));
                if (laKhongTHPTMonHoc) return false;
            }

            return true;
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
